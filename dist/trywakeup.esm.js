const t=navigator.userAgent||"",e=()=>/micromessenger/i.test(t),n=()=>/ QQ\/|MQQBrowser/i.test(t)||/qq\//i.test(t),o=()=>/iphone|ipad|ipod/i.test(t),i=()=>/android/i.test(t);const s=(()=>{let t,e;return void 0!==document.hidden?(t="hidden",e="visibilitychange"):void 0!==document.msHidden?(t="msHidden",e="msvisibilitychange"):void 0!==document.webkitHidden?(t="webkitHidden",e="webkitvisibilitychange"):(t=null,e=null),{hidden:t,visibilityChange:e}})();async function a(t={},e={}){try{if(!e||!e.clipboardToken)return null;let n=null;if(!0===t.useClipboard||void 0===t.useClipboard)n=e.clipboardToken;else if("function"==typeof t.useClipboard)try{n=t.useClipboard(e.clipboardToken)}catch(t){n=null}if(n&&"string"==typeof n&&n.length>0)return await async function(t){if(navigator.clipboard&&navigator.clipboard.writeText)return navigator.clipboard.writeText(t).catch(()=>{const e=document.createElement("textarea");e.value=t,e.setAttribute("readonly",""),e.style.position="absolute",e.style.left="-9999px",document.body.appendChild(e),e.select();try{document.execCommand("copy")}catch(t){}document.body.removeChild(e)});{const e=document.createElement("textarea");e.value=t,e.setAttribute("readonly",""),e.style.position="absolute",e.style.left="-9999px",document.body.appendChild(e),e.select();try{document.execCommand("copy")}catch(t){}return document.body.removeChild(e),Promise.resolve()}}(n),n}catch(t){}return null}function r(t){window.location.href=t}function l(t){const e=document.createElement("iframe");e.style.display="none",e.src=t,document.body.appendChild(e),setTimeout(()=>{try{document.body.removeChild(e)}catch(t){}},2e3)}function c(t){if(document.getElementById("__um_open_in_browser_tip"))return;const e=document.createElement("div");e.id="__um_open_in_browser_tip",e.style.cssText="position:fixed;left:0;top:0;background:rgba(0,0,0,0.8);width:100%;height:100%;z-index:19910324;";const n=document.createElement("div");n.innerHTML=t||'<div style="text-align:right; margin-top:2%; margin-right:5%;"><img style="width:90%; margin:0 auto;" src="//gw.alicdn.com/imgextra/i4/O1CN01UErd1C1xDN2zSmD5r_!!6000000006409-2-tps-1216-226.png"></div>',e.appendChild(n),document.body.appendChild(e);const o=document.getElementById("__um_open_in_browser_ok");o&&o.addEventListener("click",()=>{try{document.body.removeChild(e)}catch(t){}})}function d(a={},d={}){const u="number"==typeof d.timeout?d.timeout:2e3,h="function"==typeof d.proxyOpenDownload?d.proxyOpenDownload:null,p="function"==typeof d.beforeOpenDownload?d.beforeOpenDownload:null,m="function"==typeof d.afterOpenDownload?d.afterOpenDownload:null,y=d.useOpenInBrowerTips;return new Promise(f=>{let w=!1;const b=Date.now();function k(){w=!0,D(),f({success:!0,reason:"visibility"})}const g=s.visibilityChange;g&&document.addEventListener(g,function(){document.hidden&&k()},{once:!0}),window.addEventListener("blur",function(){setTimeout(()=>{!w&&(document.hidden||Date.now()-b>200)&&(w=!0,D(),f({success:!0,reason:"blur"}))},50)},{once:!0});let v=setTimeout(()=>{if(!w){if(D(),p)try{p()}catch(t){}if(h)try{h(()=>{e()||n()?c():a.downloadUrl&&r(a.downloadUrl)},{solution:a,opts:d})}catch(t){e()||n()||!a.downloadUrl||r(a.downloadUrl)}else if(e()||n())if("function"==typeof y)try{y()}catch(t){c()}else c();else a.downloadUrl&&r(a.downloadUrl);if(m)try{m()}catch(t){}f({success:!1,reason:"timeout"})}},u);function D(){try{clearTimeout(v)}catch(t){}if(g)try{document.removeEventListener(g,k)}catch(t){}try{window.removeEventListener("blur",()=>{})}catch(t){}}try{const s=a.wakeupUrl||a.wakeup_url||a.wakeup||a.scheme||"",u=a.downloadUrl||a.download_url||a.download,p=a.type||"";if(console.log("tryWakeup",s,u,p),e()||n()){if(h)h(()=>{if("function"==typeof y)try{y()}catch(t){c()}else c()},{solution:a,opts:d});else if("function"==typeof y)try{y()}catch(t){c()}else c();return}if(o()&&s&&/^https?:\/\//.test(s))r(s);else if(i()&&/Chrome|CriOS/i.test(t)&&!/Edge/i.test(t)){const t=function(t,e){try{if(!t)return null;const n=t.wakeupUrl||"";if(/^intent:/.test(n))return n;const o=n.match(/^([a-zA-Z0-9.+-]+):\/\/(.*)/),i=o?o[1]:t.scheme?t.scheme.split("://")[0]:null,s=o?o[2]:t.hostPath||"",a=t.package||"",r=encodeURIComponent(e||t.downloadUrl||"");return i&&a?`intent://${s}#Intent;scheme=${i};package=${a};S.browser_fallback_url=${r};end`:null}catch(t){return null}}(a,u);t?r(t):s&&l(s)}else/AlipayClient|alipayclient/i.test(t)&&a.alipayUrl?r(a.alipayUrl):/DINGTALK\/([\d.]+)/i.test(t)&&a.dingtalkUrl?r(a.dingtalkUrl):s&&(/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(s)?/^https?:\/\//.test(s)?r(s):l(s):r(s))}catch(t){}})}class u{constructor(t={}){this.opts=t||{},this.id=t.id||"",this.data=t.data||{},this.selector=t.selector||null,this.timeout="number"==typeof t.timeout?t.timeout:2e3,this.lazy=!!t.lazy,this.iosDeepLinksData=t.iosDeepLinksData||null,this.androidDeepLinksData=t.androidDeepLinksData||null,this.useOpenInBrowerTips=t.useOpenInBrowerTips,this.proxyOpenDownload=t.proxyOpenDownload,this.beforeOpenDownload=t.beforeOpenDownload,this.afterOpenDownload=t.afterOpenDownload,this.solution=null,this._readyCallbacks=[],this.lazy||this.start(),this.selector&&this._bindSelector(this.selector)}start(){console.log("CustomULink start",this.opts);const t="ios"===(o()?"ios":i()?"android":"unknown")?this.iosDeepLinksData:this.androidDeepLinksData;return new Promise((e,n)=>{if(t){const n={...t.find(t=>t.linkId===this.id)};if(n.wakeupUrl&&this.data&&Object.keys(this.data).length>0){const t=new URL(n.wakeupUrl);Object.entries(this.data).forEach(([e,n])=>{t.searchParams.set(e,n)}),n.wakeupUrl=t.toString()}this.solution=n,console.log("found link data",this.solution),a(this.opts,this.solution).catch(()=>{}),this._readyCallbacks.forEach(t=>{try{t(null,this.solution)}catch(t){}}),this._readyCallbacks.length=0,e(this.solution)}else this._readyCallbacks.forEach(t=>{try{t(new Error("init_failed"),null)}catch(t){}}),this._readyCallbacks.length=0,n(new Error("empty_data"))})}ready(t){this.solution?t(null,this.solution):this._readyCallbacks.push(t)}async wakeup(t={}){const e=Object.assign({},{timeout:this.timeout,proxyOpenDownload:this.proxyOpenDownload,beforeOpenDownload:this.beforeOpenDownload,afterOpenDownload:this.afterOpenDownload,useOpenInBrowerTips:this.useOpenInBrowerTips},t);return this.solution?d(this.solution,e):(await this.start(),await d(this.solution,e))}_bindSelector(t){const e=t=>{this.lazy&&!this.solution?this.start().then(()=>this.wakeup({action:"click",elementId:t.target.id,className:t.target.className})):this.wakeup({action:"click",elementId:t.target.id,className:t.target.className})};"string"==typeof t?document.addEventListener("click",function(n){let o=n.target.closest(t);for(;o&&o!==document;){try{e(n);break}catch(t){}o=o.parentNode}},!1):t&&t.addEventListener&&t.addEventListener("click",e,!1)}}function h(t=[]){const e=[];Array.isArray(t)||(t=[t]);for(const n of t){const t=new u(n);e.push(t)}return e}var p={ULink:u,startULink:h};export{u as ULink,p as default,h as startULink};
//# sourceMappingURL=trywakeup.esm.js.map
